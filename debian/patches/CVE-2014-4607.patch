Description: CVE-2014-4607 lzo: lzo1x_decompress_safe() integer overflow
Origin: https://git.centos.org/raw/rpms!lzo.git/24e0bd6a43820ba4b8cdcf361556aa939bad89ff/SOURCES!lzo-2.06-CVE-2014-4607.patch
Bug-Debian: http://bugs.debian.org/752861
Bug-RedHat: https://bugzilla.redhat.com/show_bug.cgi?id=1112418
Bug-SuSE: https://bugzilla.novell.com/show_bug.cgi?id=883947
Forwarded: not-needed
Last-Update: 2014-08-02
Applied-Upstream: 2.07

Based on the above but manually redone to apply cleanly.


--- a/minilzo/minilzo.c	2014-08-11 17:26:23.778321594 +0200
+++ b/minilzo/minilzo.c	2014-08-11 17:45:06.134375032 +0200
@@ -3136,6 +3136,8 @@
 #undef TEST_LBO
 #undef NEED_IP
 #undef NEED_OP
+#undef TEST_IV
+#undef TEST_OV
 #undef HAVE_TEST_IP
 #undef HAVE_TEST_OP
 #undef HAVE_NEED_IP
@@ -3150,6 +3152,7 @@
 #  if (LZO_TEST_OVERRUN_INPUT >= 2)
 #    define NEED_IP(x) \
             if ((lzo_uint)(ip_end - ip) < (lzo_uint)(x))  goto input_overrun
+#    define TEST_IV(x)          if ((x) > (lzo_uint)0 - (511)) goto input_overrun
 #  endif
 #endif
 
@@ -3161,6 +3164,7 @@
 #    undef TEST_OP
 #    define NEED_OP(x) \
             if ((lzo_uint)(op_end - op) < (lzo_uint)(x))  goto output_overrun
+#    define TEST_OV(x)          if ((x) > (lzo_uint)0 - (511)) goto output_overrun
 #  endif
 #endif
 
@@ -3188,14 +3192,16 @@
 #endif
 
 #if defined(NEED_IP)
-#  define HAVE_NEED_IP
+#  define HAVE_NEED_IP 1
 #else
 #  define NEED_IP(x)            ((void) 0)
+#  define TEST_IV(x)            ((void) 0)
 #endif
 #if defined(NEED_OP)
-#  define HAVE_NEED_OP
+#  define HAVE_NEED_OP 1
 #else
 #  define NEED_OP(x)            ((void) 0)
+#  define TEST_OV(x)            ((void) 0)
 #endif
 
 #if defined(HAVE_TEST_IP) || defined(HAVE_NEED_IP)
@@ -3286,6 +3292,7 @@
             {
                 t += 255;
                 ip++;
+                TEST_IV(t);
                 NEED_IP(1);
             }
             t += 15 + *ip++;
@@ -3417,6 +3424,7 @@
                     {
                         t += 255;
                         ip++;
+                        TEST_OV(t);
                         NEED_IP(1);
                     }
                     t += 31 + *ip++;
@@ -3461,6 +3469,7 @@
                     {
                         t += 255;
                         ip++;
+                        TEST_OV(t);
                         NEED_IP(1);
                     }
                     t += 7 + *ip++;
@@ -3634,6 +3643,8 @@
 #undef TEST_LBO
 #undef NEED_IP
 #undef NEED_OP
+#undef TEST_IV
+#undef TEST_OV
 #undef HAVE_TEST_IP
 #undef HAVE_TEST_OP
 #undef HAVE_NEED_IP
@@ -3648,6 +3659,7 @@
 #  if (LZO_TEST_OVERRUN_INPUT >= 2)
 #    define NEED_IP(x) \
             if ((lzo_uint)(ip_end - ip) < (lzo_uint)(x))  goto input_overrun
+#    define TEST_IV(x)          if ((x) > (lzo_uint)0 - (511)) goto input_overrun
 #  endif
 #endif
 
@@ -3659,6 +3671,7 @@
 #    undef TEST_OP
 #    define NEED_OP(x) \
             if ((lzo_uint)(op_end - op) < (lzo_uint)(x))  goto output_overrun
+#    define TEST_OV(x)          if ((x) > (lzo_uint)0 - (511)) goto output_overrun
 #  endif
 #endif
 
@@ -3686,14 +3699,16 @@
 #endif
 
 #if defined(NEED_IP)
-#  define HAVE_NEED_IP
+#  define HAVE_NEED_IP 1
 #else
 #  define NEED_IP(x)            ((void) 0)
+#  define TEST_IV(x)            ((void) 0)
 #endif
 #if defined(NEED_OP)
-#  define HAVE_NEED_OP
+#  define HAVE_NEED_OP 1
 #else
 #  define NEED_OP(x)            ((void) 0)
+#  define TEST_OV(x)            ((void) 0)
 #endif
 
 #if defined(HAVE_TEST_IP) || defined(HAVE_NEED_IP)
@@ -3784,6 +3799,7 @@
             {
                 t += 255;
                 ip++;
+                TEST_IV(t);
                 NEED_IP(1);
             }
             t += 15 + *ip++;
@@ -3915,6 +3931,7 @@
                     {
                         t += 255;
                         ip++;
+                        TEST_OV(t);
                         NEED_IP(1);
                     }
                     t += 31 + *ip++;
@@ -3959,6 +3976,7 @@
                     {
                         t += 255;
                         ip++;
+                        TEST_OV(t);
                         NEED_IP(1);
                     }
                     t += 7 + *ip++;
--- a/src/lzo1_d.ch	2014-08-11 17:38:45.522356910 +0200
+++ b/src/lzo1_d.ch	2014-08-11 17:44:05.030372122 +0200
@@ -73,6 +73,8 @@
 #undef TEST_LBO
 #undef NEED_IP
 #undef NEED_OP
+#undef TEST_IV
+#undef TEST_OV
 #undef HAVE_TEST_IP
 #undef HAVE_TEST_OP
 #undef HAVE_NEED_IP
@@ -88,6 +90,7 @@
 #  if (LZO_TEST_OVERRUN_INPUT >= 2)
 #    define NEED_IP(x) \
             if ((lzo_uint)(ip_end - ip) < (lzo_uint)(x))  goto input_overrun
+#    define TEST_IV(x)          if ((x) > (lzo_uint)0 - (511)) goto input_overrun
 #  endif
 #endif
 
@@ -99,6 +102,7 @@
 #    undef TEST_OP              /* don't need both of the tests here */
 #    define NEED_OP(x) \
             if ((lzo_uint)(op_end - op) < (lzo_uint)(x))  goto output_overrun
+#    define TEST_OV(x)          if ((x) > (lzo_uint)0 - (511)) goto output_overrun
 #  endif
 #endif
 
@@ -129,14 +133,16 @@
 #endif
 
 #if defined(NEED_IP)
-#  define HAVE_NEED_IP
+#  define HAVE_NEED_IP 1
 #else
 #  define NEED_IP(x)            ((void) 0)
+#  define TEST_IV(x)            ((void) 0)
 #endif
 #if defined(NEED_OP)
-#  define HAVE_NEED_OP
+#  define HAVE_NEED_OP 1
 #else
 #  define NEED_OP(x)            ((void) 0)
+#  define TEST_OV(x)            ((void) 0)
 #endif
 
 
--- a/src/lzo1b_d.ch	2014-08-11 17:47:05.254380703 +0200
+++ b/src/lzo1b_d.ch	2014-08-11 17:49:51.218388605 +0200
@@ -184,6 +184,7 @@
                 {
                     t += 255;
                     ip++;
+                    TEST_OV(t);
                     NEED_IP(1);
                 }
                 t += (M4_MIN_LEN - M3_MIN_LEN) + *ip++;
--- a/src/lzo1f_d.ch	2014-08-11 17:50:12.026389596 +0200
+++ b/src/lzo1f_d.ch	2014-08-11 17:51:18.402392756 +0200
@@ -81,6 +81,7 @@
             {
                 t += 255;
                 ip++;
+                TEST_IV(t);
                 NEED_IP(1);
             }
             t += 31 + *ip++;
@@ -135,6 +136,7 @@
                         {
                             t += 255;
                             ip++;
+                            TEST_OV(t);
                             NEED_IP(1);
                         }
                         t += 31 + *ip++;
--- a/src/lzo1x_d.ch	2014-08-11 18:02:09.226423744 +0200
+++ b/src/lzo1x_d.ch	2014-08-11 17:52:16.022395500 +0200
@@ -128,6 +128,7 @@
             {
                 t += 255;
                 ip++;
+                TEST_IV(t);
                 NEED_IP(1);
             }
             t += 15 + *ip++;
@@ -264,6 +265,7 @@
                     {
                         t += 255;
                         ip++;
+                        TEST_OV(t);
                         NEED_IP(1);
                     }
                     t += 31 + *ip++;
@@ -308,6 +310,7 @@
                     {
                         t += 255;
                         ip++;
+                        TEST_OV(t);
                         NEED_IP(1);
                     }
                     t += 7 + *ip++;
--- a/src/lzo2a_d.ch	2014-08-11 17:52:51.714397199 +0200
+++ b/src/lzo2a_d.ch	2014-08-11 17:53:39.550399477 +0200
@@ -128,6 +128,7 @@
             {
                 t += 255;
                 ip++;
+                TEST_OV(t);
                 NEED_IP(1);
             }
             t += *ip++;
